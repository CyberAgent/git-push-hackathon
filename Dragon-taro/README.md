# Fast Gist

## 使い方

[oauth.io](https://qiita.com/RingCaptcha/items/7a63f2947df092131c83)というサービスを使って認証をとっています。

上記のサイトの設定に沿ってアプリを作成し、oauth.io でのアクセストークンを

```js:secret.js
export const ACCESS_TOKEN = "YOUR ACCESS TOKEN";
```

に追記します。

oauth.io での設定の際に scope の設定で gist を設定するのを忘れないようにしてください。（ここで僕は無駄に詰んでしまいました。）

これをしてから、

```shell
npm install
npm run build-css
npm run start
```

これで webpack-dev-server が立ち上がります。

## こだわりポイント

### 設計

redux を書いたことはあったのですが適切な設計を考えたことがなかったので、今回は github でいくつかの redux のアプリを参考にしながら設計を考えて作成しました。

特に、ディレクトリ分割やファイル分割を頑張り、どこに何が書いてあるかをできるだけわかりやすく書いたつもりです。

また github で他の redux アプリをみているときに、redux-thunk に比べてコードが綺麗に整理できる印象を感じたので redux-saga を選定しました。（今回初めて使ってみて、最初は暗号のように感じたものの慣れると使いやすいなと思いました。）

state も役割ごとに分けて必要な分だけ参照できるように conteiner で設定しました。

state は gists(gist の一覧), gist(個々の gist の Object← 命名が微妙でした、、), editor(editor での state), user(user の情報), oauth(認証が取れてるかどうか)で管理しています。

基本的には redux でほとんどの state を管理するようにしたので、pure なコンポーネントを増やせました。

#### src 以下のディレクトリ構成

```
src
|-actions
|-components（基本的なviewはここ）
|  |-parts（共通のもの）
|  |-gistView（gistの表示関連）
|  |-gistEditor（gistの編輯関連）
|
|-css
|-containers（reduxとの接続）
|-sagas（非同期処理）
|-reducers
```

### ファイルからの読み取り

Upload File または Drag&Drop によりファイルから gist の file を作成できるようにしました。これによりわざわざファイルからコピーしなくても一括で gist を作成することができます。（複数ファイル対応済み）

画面上どこでもドロップできるようにしておきました。（結構便利です！！）

### 速度

このアプリではできるだけ速度を出して、本家より速くなることを目標にしました。具体的には、

- SPA で構築
- 初期のロードの際は gist の中身は取得しない（gists/:id は叩かない）
- gist 一覧で hover した際にリンク先の gist を先に取得して state に格納
- gist の一覧は初回以外は load 画面に移行せず非同期に更新しておく

### 下書き機能

新規作成のときに localStorage に下書きを保存するようにしました。そのため編輯画面を離れたりリロードをしても再び編集画面が render されるときに confirm がでるようにしました。

期間延長に伴い編集のときも下書きの保存がされるようにしました。

間違えてリロードをしてしまっても問題ありません。

### セキュリティ

主に access_token をどこで管理するのかを検討しました。

具体的には、

```
- LocalStorage
  - sessionLocalStorage（これを採用）
    - これなら有効期限があるし、localStorageの利点（毎回サーバーに送らない）も有効に活用できそう
  - ノーマルのLocalStorage
    - 有効期限がないから微妙？永続はセキュリティ的にまずそう
- cookie
  - 一般的だから良さそうだが、不必要に毎回データを送ってしまうのはどうなんだろう？
- reactのstateで管理しちゃう
  - 永続化させないからセキュア
  - その代わりリロードのたびにログインを求めらてUXがくそ

そもそもどの設計にしてもユーザーから簡単にアクセスキーを抜かれてしまうのはどうなんだろ、、
これは世の中に出回ってるアプリと一緒なのかな？

フロントだけを考えるのなら、XSSさえないようにしておけば第三者にトークンをハイジャックされる心配はない
→ markdownのparseに気をつけるなどの方が、トークンの管理の方法を考えるよりも大事なのかも？
```

こんなことを検討して localStorage にしました。でも、結局毎回サーバーに送る設計になったので cookie でもよかったのかなとは思っています。

### エラーハンドリング

先日のエラーの嵐の中で認証しているかどうかの判定を頑張りました。

認証が取れていないとき以外は root にリダイレクトという設計にしてあります。

悩んだのですが、毎回認証を取っていたら UX が損なわれるので、エディターとリロード時のみの認証の確認をするようにしました。

今までしっかりと書いたことがなかったのでレビューいただけると幸いです。

## 悩んだところ

### どこまでファイル分割をするか

ファイルを分割しないと読みにくくて大変なのはわかるのですが、分割しすぎるとそれはそれでファイル間の移動が多くなりすぎて面倒に感じました。

ある程度まとめたりはしている（例えば、1state→1file にはせずに、似ている state は一つのファイルにまとめてある）のですが、この塩梅が難しいなと感じました。

### 非同期の絡まないロジックの配置場所

`Dragon-taro/src/components/gistEditor/parts/File.js`のコンポーネントにはそこそこロジックが入ってます。（削除とか追加とか）

state 自体は redux で管理しないと都合が悪かったのでそうしているのですが、その他のロジックは sagas に入れるには不適切だし action に入れても肥大化しそうなので、コンポーネントにもたせました。これがいいのか悪いのか疑問です。

## 反省点

- Editor 周りのコードが肥大化してしまった
- loading と loaded のアクションがいろんなところに散りばめられてしまった
- css の設計が react/redux ほどは凝れずコンポーネント化がうまくできなかった
- アロー関数と普通の関数が混在してしまった（これってどうするのが正解なんですか、、？）
- デザインが質素
